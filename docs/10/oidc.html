<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Micro Focus Content Manager SDK 10.0: Open ID Connect Authentication</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygenBase.css" rel="stylesheet" type="text/css" />
<link href="doxyStylesheet.css" rel="stylesheet" type="text/css"/>
<link href="doxySidebarFixes.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="mf_logo_white_small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Micro Focus Content Manager SDK 10.0
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('oidc.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Open ID Connect Authentication </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#auth_overview">Authentication overview</a></li>
<li class="level1"><a href="#oidc_adfs">ADFS for WebClient and ServiceAPI</a><ul><li class="level2"><a href="#autotoc_md19">Create the AD FS  Application</a><ul><li class="level3"><a href="#autotoc_md20">Examples</a><ul><li class="level4"><a href="#autotoc_md21">New AD FS application</a></li>
<li class="level4"><a href="#autotoc_md22">Add Redirect URI</a></li>
<li class="level4"><a href="#autotoc_md23">Generate Secret</a></li>
<li class="level4"><a href="#autotoc_md24">Specify Web API identifier</a></li>
</ul>
</li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md25">Add the settings to the Web Client</a><ul><li class="level3"><a href="#autotoc_md26">Example</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md27">Configure AD FS for Office Integration access</a><ul><li class="level3"><a href="#autotoc_md28">Examples</a><ul><li class="level4"><a href="#autotoc_md29">Add native application</a></li>
<li class="level4"><a href="#autotoc_md30">Add permissions for native application</a></li>
<li class="level4"><a href="#autotoc_md31">Specifiy claims to be included in token</a></li>
</ul>
</li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md32">Add office integration the settings to the Web Client</a></li>
</ul>
</li>
<li class="level1"><a href="#oidc_azuread">AzureAD for WebClient and ServiceAPI</a><ul><li class="level2"><a href="#autotoc_md33">Create the Azure AD Application</a><ul><li class="level3"><a href="#autotoc_md34">Example</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md35">Add a secret</a><ul><li class="level3"><a href="#autotoc_md36">Example</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md37">Configure Tokens</a></li>
<li class="level2"><a href="#autotoc_md38">Configure permissions</a><ul><li class="level3"><a href="#autotoc_md39">Example</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md40">Configure authentication in hptrim.config</a><ul><li class="level3"><a href="#autotoc_md41">Example config</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md42">Enable redirect</a></li>
<li class="level2"><a href="#autotoc_md43">Logout</a><ul><li class="level3"><a href="#autotoc_md44">Example</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md45">Allow anonymous access in the IIS</a></li>
</ul>
</li>
<li class="level1"><a href="#oidc_google">Google authentication for WebClient and ServiceAPI</a><ul><li class="level2"><a href="#autotoc_md46">Create the Google Credentials</a><ul><li class="level3"><a href="#autotoc_md47">Example</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md48">Configure authentication in hptrim.config</a><ul><li class="level3"><a href="#autotoc_md49">Example config</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md50">Enable redirect</a></li>
<li class="level2"><a href="#autotoc_md51">Logout</a><ul><li class="level3"><a href="#autotoc_md52">Example</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md53">Allow anonymous access in the IIS</a></li>
</ul>
</li>
<li class="level1"><a href="#oidc_azuread_desktop">AzureAD for Content Manager Desktop</a><ul><li class="level2"><a href="#autotoc_md54">Create the Azure AD Application</a><ul><li class="level3"><a href="#autotoc_md55">Example</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md56">Configure permissions</a><ul><li class="level3"><a href="#autotoc_md57">Example</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md58">Configure authentication in Content Manager Enterprise Studio</a><ul><li class="level3"><a href="#autotoc_md59">Example</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md60">Configure Azure AD for Office Integration access</a><ul><li class="level3"><a href="#autotoc_md61">Example Config.xml</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md62">Troubleshooting Azure AD for Office Integration access</a><ul><li class="level3"><a href="#autotoc_md63">Error AADSTS500011: The resource principal named https://MYSERVER/contentmanager/ was not found in the tenant named XXXX-XXXX-XXXXX-XXXXXX.</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_doc_13___oidc_auth"></a></p>
<h1><a class="anchor" id="auth_overview"></a>
Authentication overview</h1>
<p>OAuth authentication is managed via OpenId Connect authentication. The authentication is configured in yout Identity Provider (e.g. Azure AD) and then the appropriate details are stored in Content Manager in the hptrim.config file, for the Web Client and ServiceAPI or Enterprise Studio for the desktop client.</p>
<h1><a class="anchor" id="oidc_adfs"></a>
ADFS for WebClient and ServiceAPI</h1>
<p>As of CM 10 the CM web applications (ServiceAPI, WebDrawer and Web Client) have an OpenId Connect authentication provider built in. This document describes creating an AD FS application and configuring the CM web application.</p>
<h2><a class="anchor" id="autotoc_md19"></a>
Create the AD FS  Application</h2>
<p>To create the AD FS application:</p>
<ol type="1">
<li>create a new Application Group</li>
<li>select 'server application accessing a web application'</li>
<li>Enter a name.</li>
<li>press Next</li>
<li>take note of the client identifier</li>
<li>add a Redirect URI. The redirect URI must be all in lowercase and be the URL of the Content Manager web site with the suffix '/serviceapi/auth/openid. For example: <code><a href="https://myserver/contentmanager/serviceapi/auth/openid">https://myserver/contentmanager/serviceapi/auth/openid</a></code>.</li>
<li>press Next</li>
<li>Generate a shared secret and take note of this secret</li>
<li>press next</li>
<li>add an identifier, for example: <code><a href="https://MyServer/contentmanager/">https://MyServer/contentmanager/</a></code></li>
<li>press next</li>
<li>choose an access control policy (for example: 'Give access to everyone</li>
<li>In 'Configure Application permissions select email, openid, and profile</li>
<li>Complete the Application Group</li>
</ol>
<h3><a class="anchor" id="autotoc_md20"></a>
Examples</h3>
<h4><a class="anchor" id="autotoc_md21"></a>
New AD FS application</h4>
<p><img src="oidc_adfs_1.png" alt="" class="inline"/></p>
<h4><a class="anchor" id="autotoc_md22"></a>
Add Redirect URI</h4>
<p><img src="oidc_adfs_2.png" alt="" class="inline"/></p>
<h4><a class="anchor" id="autotoc_md23"></a>
Generate Secret</h4>
<p><img src="oidc_adfs_3.png" alt="" class="inline"/></p>
<h4><a class="anchor" id="autotoc_md24"></a>
Specify Web API identifier</h4>
<p><img src="oidc_adfs_4.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md25"></a>
Add the settings to the Web Client</h2>
<p>To configure the Web Client edit the hprmServiceApi.config file and add (or edit) the authentication element to look similar to the example below.</p>
<ul>
<li>Client Id and secret come from the previous section</li>
<li>issuerUri is found in the AD FS console - Endpoints, in the OpenID Connect section</li>
<li>name must be 'openid'</li>
</ul>
<h3><a class="anchor" id="autotoc_md26"></a>
Example</h3>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">authentication</span> <span class="keyword">allowAnonymous</span>=<span class="stringliteral">&quot;false&quot;</span> <span class="keyword">slidingSessionMinutes</span>=<span class="stringliteral">&quot;30&quot;</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">openIdConnect</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">add</span> </div>
<div class="line">      <span class="keyword">name</span>=<span class="stringliteral">&quot;openid&quot;</span> </div>
<div class="line">      <span class="keyword">clientID</span>=<span class="stringliteral">&quot;CLIENT_ID&quot;</span> </div>
<div class="line">      <span class="keyword">clientSecret</span>=<span class="stringliteral">&quot;SECRET&quot;</span> </div>
<div class="line">      <span class="keyword">issuerURI</span>=<span class="stringliteral">&quot;https://MyServer/adfs/.well-known/openid-configuration&quot;</span>/&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">openIdConnect</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">authentication</span>&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md27"></a>
Configure AD FS for Office Integration access</h2>
<p>The office integration requires an access token to allow it ro authenticate with the Web Client, this can be configured in AD FS:</p>
<ol type="1">
<li>go the Application group configured above</li>
<li>use 'Add Application' to add a native application</li>
<li>preserve Client Id for later use</li>
<li>complete the native application</li>
<li>edit the Web API application and in Client Permissions add the new client application selecting the scopes email, openid and profile</li>
<li>in Issuance Transform Rules add a new Rule</li>
<li>select 'Send LDAP Attributes'</li>
<li>select Next</li>
<li>choose Active Directory as the attribute store</li>
<li>map these two claims,<ul>
<li>Display Name - Name</li>
<li>User-Principal-Name - UPN</li>
</ul>
</li>
<li>Finish</li>
</ol>
<h3><a class="anchor" id="autotoc_md28"></a>
Examples</h3>
<h4><a class="anchor" id="autotoc_md29"></a>
Add native application</h4>
<p><img src="oidc_adfs_5.png" alt="" class="inline"/></p>
<h4><a class="anchor" id="autotoc_md30"></a>
Add permissions for native application</h4>
<p><img src="oidc_adfs_6.png" alt="" class="inline"/></p>
<h4><a class="anchor" id="autotoc_md31"></a>
Specifiy claims to be included in token</h4>
<p><img src="oidc_adfs_7.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md32"></a>
Add office integration the settings to the Web Client</h2>
<p>The office integration authentication settings are stored in the file ADFS\config.xml in the web client install directory:</p><ul>
<li>clientAuthority - the URL to your AD FS server</li>
<li>clientResourceUri - the relying party identifier from the AD Fs Web API</li>
<li>clientID - the Client Id from the AD FS native application</li>
<li>The Redirect URI from the AD FS native application</li>
</ul>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">adfsClient</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">clientAuthority</span>&gt;<span class="keyword">https:</span>//<span class="keyword">acme.com</span>/<span class="keyword">adfs</span>&lt;/<span class="keywordtype">clientAuthority</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">clientResourceUri</span>&gt;<span class="keyword">https:</span>//<span class="keyword">acme.com</span>/<span class="keyword">contentmanager</span>/&lt;/<span class="keywordtype">clientResourceUri</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">clientID</span>&gt;<span class="keyword">ab762716-544d-4aeb-a526-687b73838a34</span>&lt;/<span class="keywordtype">clientID</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">clientReturnUri</span>&gt;<span class="keyword">https:</span>//<span class="keyword">acme.com</span>/<span class="keyword">contentmanager</span>/&lt;/<span class="keywordtype">clientReturnUri</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">adfsClient</span>&gt;</div>
</div><!-- fragment --><h1><a class="anchor" id="oidc_azuread"></a>
AzureAD for WebClient and ServiceAPI</h1>
<p>As of CM 10 the CM web applications (ServiceAPI, WebDrawer and Web Client) have an OpenId Connect authentication provider built in. This document describes creating an Azure Ad application and configuring the CM web application.</p>
<h2><a class="anchor" id="autotoc_md33"></a>
Create the Azure AD Application</h2>
<p>To create the Azure AD application:</p>
<ol type="1">
<li>From with portal.azure.com go to Azure AD.</li>
<li>Go to App Registrations and select New Registration.</li>
<li>Enter a name.</li>
<li>Under Redirect URI leave Web selected.</li>
<li>The value in the Redirect URI is important, it must be lowercase and it must be the URL to your application (e.g. <a href="https://mydomain.com/cmwebdrawer">https://mydomain.com/cmwebdrawer</a>) followed by the path to the authentication provider (for example /auth/openid). The /auth/ component is fixed but the 'openid' is the name you will supply in hptrim.config later and so can be any string, as long as it matches the value in hptrim.config. For the web client the path must include the path to the ServiceAPI, for example: <a href="https://mydomain.com/contentManager/serviceapi/auth/openid">https://mydomain.com/contentManager/serviceapi/auth/openid</a>.</li>
</ol>
<h3><a class="anchor" id="autotoc_md34"></a>
Example</h3>
<p><img src="azuread_app_1.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md35"></a>
Add a secret</h2>
<p>From Certificates and Secrets add a secret and copy it some where you can find it later.</p>
<h3><a class="anchor" id="autotoc_md36"></a>
Example</h3>
<p><img src="azuread_secret.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md37"></a>
Configure Tokens</h2>
<p>From the Authentication section go to 'Select the tokens you would like to be issued' and check the option ID Tokens.</p>
<h2><a class="anchor" id="autotoc_md38"></a>
Configure permissions</h2>
<p>From API Permissions add the following delegated Microsoft Graph permissions:</p><ul>
<li>email</li>
<li>offline_access</li>
<li>openid</li>
<li>profile</li>
<li>User.Read</li>
<li>Files.Read</li>
<li>Files.Read.All</li>
<li>Files.ReadWrite</li>
<li>Sites.Read.All</li>
<li>Sites.ReadWrite.All</li>
<li>User.Read</li>
</ul>
<p>Select 'Grant Admin Access' to grant access to all permissions.</p>
<h3><a class="anchor" id="autotoc_md39"></a>
Example</h3>
<p><img src="azuread_webclient_permissions.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md40"></a>
Configure authentication in hptrim.config</h2>
<p>To use the Azure AD app created above edit hptrim.config (hprmServiceAPI.config in the Web Client) so that it has am authentication similar to the one below.</p>
<ol type="1">
<li>The name must match the last segment of the Redirect URI path.</li>
<li>Client ID is the application ID from the Azure Ad Overview.</li>
<li>The secret is the one saved when creating the App. If it was not saved created a new one in Certificates and Secrets.</li>
<li>Get the issuerUri from Overview &gt; Endpoints &gt; OpenID Connect metadata document</li>
</ol>
<h3><a class="anchor" id="autotoc_md41"></a>
Example config</h3>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">authentication</span> <span class="keyword">allowAnonymous</span>=<span class="stringliteral">&quot;false&quot;</span> <span class="keyword">slidingSessionMinutes</span>=<span class="stringliteral">&quot;60&quot;</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">openIdConnect</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">add</span></div>
<div class="line">            <span class="keyword">name</span>=<span class="stringliteral">&quot;openid&quot;</span></div>
<div class="line">            <span class="keyword">clientID</span>=<span class="stringliteral">&quot;ae39011d-52e7-4ecc-b9eb-87d6d876dd&quot;</span></div>
<div class="line">            <span class="keyword">clientSecret</span>=<span class="stringliteral">&quot;_MqXXXXXXXXXXXXXXXG[sp3GrMfD:&quot;</span></div>
<div class="line">            <span class="keyword">issuerURI</span>=<span class="stringliteral">&quot;https://login.microsoftonline.com/08363ee4-6592-4325-9d5a-123456789/v2.0/.well-known/openid-configuration&quot;</span></div>
<div class="line">        /&gt;</div>
<div class="line">    &lt;/<span class="keywordtype">openIdConnect</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">authentication</span>&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md42"></a>
Enable redirect</h2>
<p>The web client will not re-direct the authentication endpoint unless the Html feature is enabled in hprmServiceAPI.config. To do this:</p>
<ol type="1">
<li>edit hprmServiceAPI.config</li>
<li>find the property named 'serviceFeatures'</li>
<li>Add the feature Html</li>
</ol>
<h2><a class="anchor" id="autotoc_md43"></a>
Logout</h2>
<p>For WebDrawer the logout link is configured in the uiSettings. It should contain '~/auth/logout'. In the Web Client a logout link will be displayed automatically when OpenId Connect authentication is enabled.</p>
<h3><a class="anchor" id="autotoc_md44"></a>
Example</h3>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">uiSettings</span></div>
<div class="line">  <span class="keyword">logoutLink</span>=<span class="stringliteral">&quot;~/auth/logout&quot;</span></div>
<div class="line">  ...</div>
<div class="line">/&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md45"></a>
Allow anonymous access in the IIS</h2>
<p>IIS will not be handling authentication so we use IIS Manager to allow anonymous access only.</p>
<p><img src="iis_anon.PNG" alt="" class="inline" title="image 1"/></p>
<h1><a class="anchor" id="oidc_google"></a>
Google authentication for WebClient and ServiceAPI</h1>
<p>As of CM 10 the CM web applications (ServiceAPI, WebDrawer and Web Client) have an OpenId Connect authentication provider built in. This document describes creating Google credentials and configuring the CM web application.</p>
<h2><a class="anchor" id="autotoc_md46"></a>
Create the Google Credentials</h2>
<p>To create the Google credentials:</p>
<ol type="1">
<li>Go to <a href="https://console.developers.google.com/">https://console.developers.google.com/</a>,</li>
<li>Select Credentials &gt; OAuth Client ID,</li>
<li>Set Application type to 'Web Application'.</li>
<li>Add your domain in the Authorized JavaScript origins</li>
<li>The value in Authorized redirect URIs is important, it must be lowercase and it must be the URL to your application (e.g. <a href="https://mydomain.com/cmwebdrawer">https://mydomain.com/cmwebdrawer</a>) followed by the path to the authentication provider (for example /auth/openid). The /auth/ component is fixed but the 'openid' is the name you will supply in hptrim.config later and so can be any string, as long as it matches the value in hptrim.config. For the web client the path must include the path to the ServiceAPI, for example: <a href="https://mydomain.com/contentManager/serviceapi/auth/openid">https://mydomain.com/contentManager/serviceapi/auth/openid</a>.</li>
<li>On saving the Client ID and Client Secret will be displayed, preserve them for later use.</li>
</ol>
<h3><a class="anchor" id="autotoc_md47"></a>
Example</h3>
<p><img src="google_credentials.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md48"></a>
Configure authentication in hptrim.config</h2>
<p>To use the Google credentials created above edit hptrim.config (hprmServiceAPI.config in the Web Client) so that it has am authentication similar to the one below.</p>
<ol type="1">
<li>The name must match the last segment of the Redirect URI path.</li>
<li>Client ID is the one preserved earlier.</li>
<li>The secret is the one preserved earlier.</li>
<li>The issuerURI is: <a href="https://accounts.google.com">https://accounts.google.com</a></li>
</ol>
<h3><a class="anchor" id="autotoc_md49"></a>
Example config</h3>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">authentication</span> <span class="keyword">allowAnonymous</span>=<span class="stringliteral">&quot;false&quot;</span> <span class="keyword">slidingSessionMinutes</span>=<span class="stringliteral">&quot;2&quot;</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">openIdConnect</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">add</span></div>
<div class="line">            <span class="keyword">name</span>=<span class="stringliteral">&quot;openid&quot;</span></div>
<div class="line">            <span class="keyword">clientID</span>=<span class="stringliteral">&quot;741419278958-abcdefghijklmemopqrs.apps.googleusercontent.com&quot;</span></div>
<div class="line">            <span class="keyword">clientSecret</span>=<span class="stringliteral">&quot;jl-BiX7685hjgf76857y&quot;</span></div>
<div class="line">            <span class="keyword">issuerURI</span>=<span class="stringliteral">&quot;https://accounts.google.com&quot;</span></div>
<div class="line">        /&gt;</div>
<div class="line">    &lt;/<span class="keywordtype">openIdConnect</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">authentication</span>&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md50"></a>
Enable redirect</h2>
<p>The web client will not re-direct the authentication endpoint unless the Html feature is enabled in hprmServiceAPI.config. To do this:</p>
<ol type="1">
<li>edit hprmServiceAPI.config</li>
<li>find the property named 'serviceFeatures'</li>
<li>Add the feature Html</li>
</ol>
<h2><a class="anchor" id="autotoc_md51"></a>
Logout</h2>
<p>For WebDrawer the logout link is configured in the uiSettings. It should contain '~/auth/logout'. In the Web Client a logout link will be displayed automatically when OpenId Connect authentication is enabled.</p>
<h3><a class="anchor" id="autotoc_md52"></a>
Example</h3>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">uiSettings</span></div>
<div class="line">  <span class="keyword">logoutLink</span>=<span class="stringliteral">&quot;~/auth/logout&quot;</span></div>
<div class="line">  ...</div>
<div class="line">/&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md53"></a>
Allow anonymous access in the IIS</h2>
<p>IIS will not be handling authentication so we use IIS Manager to allow anonymous access only. <img src="iis_anon.PNG" alt="" class="inline" title="image 1"/></p>
<h1><a class="anchor" id="oidc_azuread_desktop"></a>
AzureAD for Content Manager Desktop</h1>
<p>OpenID Connect may be used to authenticate with the Content Manager desktop client, this document details how to configure this.</p>
<h2><a class="anchor" id="autotoc_md54"></a>
Create the Azure AD Application</h2>
<p>To create the Azure AD application:</p>
<ol type="1">
<li>From with portal.azure.com go to Azure AD.</li>
<li>Go to App Registrations and select New Registration.</li>
<li>Enter a name.</li>
<li>Select 'Public native client' in the Redirect URI</li>
<li>Enter this redirect Uri 'urn:ietf:wg:oauth:2.0:oob'</li>
</ol>
<h3><a class="anchor" id="autotoc_md55"></a>
Example</h3>
<p><img src="azuread_app_desktop_1.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md56"></a>
Configure permissions</h2>
<p>From API Permissions add the following delegated Microsoft Graph permissions:</p><ul>
<li>email</li>
<li>offline_access</li>
<li>openid</li>
<li>profile</li>
<li>User.Read</li>
<li>Files.Read</li>
<li>Files.Read.All</li>
<li>Files.ReadWrite</li>
<li>Sites.Read.All</li>
<li>Sites.ReadWrite.All</li>
<li>User.Read</li>
</ul>
<p>Select 'Grant Admin Access' to grant access to all permissions.</p>
<h3><a class="anchor" id="autotoc_md57"></a>
Example</h3>
<p><img src="azuread_app_desktop_2.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md58"></a>
Configure authentication in Content Manager Enterprise Studio</h2>
<p>To use the Azure AD app created above open Content Manager Enterprise Studio and:</p><ol type="1">
<li>from the database choose Authentication &gt; OpenID</li>
<li>The OpenID Issuer URL is taken from the Azure App - Overview &gt; Endpoints &gt; OpenID Connect metadata document</li>
<li>The Client Id is taken from the Azure App - Overview &gt; Application ID</li>
<li>Client secret should be empty</li>
<li>Client app scope should contain 'openid email offline_access'</li>
</ol>
<h3><a class="anchor" id="autotoc_md59"></a>
Example</h3>
<p><img src="/images/azuread_app_desktop_3.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md60"></a>
Configure Azure AD for Office Integration access</h2>
<p>The office integration requires an access token to allow it to authenticate with the Web Client, this can be configured in Azure AD:</p>
<ol type="1">
<li>create an Azure App for Web Authentication, you may use the one you created to authenticate with the CM Web Client,</li>
<li>create (or edit) the file ADFS\config.xml in your CM Web Client installation folder and set it as follows:<ul>
<li>clientAuthority - '<a href="https://login.windows.net/'">https://login.windows.net/'</a> followed by your domain: e.g. <a href="https://login.windows.net/cmofficedev.onmicrosoft.com">https://login.windows.net/cmofficedev.onmicrosoft.com</a></li>
<li>clientResourceUri - the Application ID URI from your CM Web Client Azure App</li>
<li>clientID - the Application Id from your CM Desktop Azure App</li>
<li>clientReturnUri - urn:ietf:wg:oauth:2.0:oob</li>
</ul>
</li>
<li>from the Azure App for Web Authentication:<ol type="a">
<li>go to 'Expose an API',</li>
<li>select 'Add a Scope',</li>
<li>enter the following values:<ul>
<li>Scope name: access_as_user,</li>
<li>Who can consent: Admins and Users,</li>
<li>Admin consent display name: Office can act as the user</li>
<li>Admin consent description: Enable Office to call the add-in's web APIs with the same rights as the current user</li>
<li>User consent display name: Office can act as you</li>
<li>User consent description: Enable Office to call the add-in's web APIs with the same rights that you have</li>
</ul>
</li>
<li>Click the 'Add scope' button</li>
</ol>
</li>
<li>from the CM Desktop Azure App go to API Permissions and:<ol type="a">
<li>select 'Add a Permission'</li>
<li>choose 'My APIs'</li>
<li>select the Web Client Application <br  />
</li>
<li>select the access_as_user permissions</li>
<li>select 'Add permission'.</li>
</ol>
</li>
<li>The web client authentication information needs to updated to be made aware of the new client, to do this:<ol type="a">
<li>from the CM Desktop Azure App copy the 'Application ID URI' (will probably look similar to this: api://cf2501bd-10f0-4ad6-96dc-f5cf7b2b3bf5)</li>
<li>edit the Web Client hprmServiceAPI.config file</li>
<li>in the 'add' element of the openIDConnect element add a new attribute called 'appIdURI' (this is a case senstitive name),</li>
<li>the value of appIdURI should be the 'Application ID URI' from the CM Desktop Azure App</li>
</ol>
</li>
</ol>
<h3><a class="anchor" id="autotoc_md61"></a>
Example Config.xml</h3>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">adfsClient</span>&gt;</div>
<div class="line">&lt;<span class="keywordtype">clientAuthority</span>&gt;<span class="keyword">https:</span>//<span class="keyword">login.windows.net</span>/<span class="keyword">cmofficedev.onmicrosoft.com</span>&lt;/<span class="keywordtype">clientAuthority</span>&gt;</div>
<div class="line">&lt;<span class="keywordtype">clientResourceUri</span>&gt;<span class="keyword">api:</span>//<span class="keyword">auchurchla02:3000</span>/09<span class="keyword">f0ec5c-87e9-4568-8b60-4eb3e20de75e</span>&lt;/<span class="keywordtype">clientResourceUri</span>&gt;</div>
<div class="line">&lt;<span class="keywordtype">clientID</span>&gt;<span class="keyword">cf2501bd-10f0-4ad6-96dc-f5cf7b2b3bf5</span>&lt;/<span class="keywordtype">clientID</span>&gt;</div>
<div class="line">&lt;<span class="keywordtype">clientReturnUri</span>&gt;<span class="keyword">http:</span>//<span class="keyword">MyWebClient</span>&lt;/<span class="keywordtype">clientReturnUri</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">adfsClient</span>&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md62"></a>
Troubleshooting Azure AD for Office Integration access</h2>
<h3><a class="anchor" id="autotoc_md63"></a>
Error AADSTS500011: The resource principal named https://MYSERVER/contentmanager/ was not found in the tenant named XXXX-XXXX-XXXXX-XXXXXX.</h3>
<p>If you get this error try using the Client ID in clientResourceUri, rather than Application ID URI. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
